import CodeBlock from '@theme/CodeBlock';
import CommentCommitPush from '/comment-commit-push.mdx';

# TP3 : MessageBoard

## Consignes (15% de la note finale)
- Lisez toutes les instructions et la grille de correction avant de commencer
- Vous **DEVEZ** faire au moins les migrations et les commits demandés mais vous pouvez en faire plus sans problème, tant que vous les documentez correctement

A faire pour prof:
- Comment ca fonctionne si le user a encore son token? https://stackoverflow.com/questions/14448604/using-razor-how-do-i-render-a-boolean-to-a-javascript-variable
- Verifier que le banissement fonctionne bien
- Afficher le username et non le email dans le menu de login
- Ajouter/modifier des unit tests avec Moq
- Faire une grille de correction (Est-ce possible de faire des points si on bloque quelque pars? Eviter que ce soit un TP 1 ou 0!!)
- Corriger les dates des messages (rentrer une date fixe)
- Corriger le seed pour qu'il ne modifie pas les entrees a chaque fois!
    - SecurityStamp
    - ConcurrencyStamp
    - PasswordHash
- Simplifier les calls ajax?
- Essayer de tout mettre en francais (incluant les dates et tout le reste)

## Objectif

Le but de ce TP est d'ajouter une gestion d'usagers à une application simple qui permet d'écrire des messages à propos de certains sujets (**Boards**).

En plus des **utilisateurs** normaux, vous devrez créer deux **rôles** pour gérer cette application:
- **Admin**
- **Moderator**

## Mettre en place Identity
- Ajout des packages pour Identity
- Ajout d'une classe ApplicationUser qui hérite de IdentityUser
- TODO: Ajouter les étapes

## Générez les pages Identity
- Scaffolding de Identity
- Ajouter les pages Razor
    app.MapRazorPages();
- Ajout du partial view de login à la page de navigation (Aligner a droite!)
- TODO: Ajouter les étapes

## Créer les liens avec ApplicationUser et faire un Seed

- Un **utilisateur** peut avoir un ou plusieurs **Messages**
- Modifiez le seed pour ajouter 3 utilisateurs: un administrateur, un modérateur et un utilisateur normal (avec les roles admin et moderator quand necessaire)
- Associez les messages déjà existants à vos utilisateurs (chaque message d'un même Board doit être associé à un utilisateur différent)
- Modifiez la création de message pour qu'elle ne soit faisable que par un utilisateur et l'associé à son message
- Modifiez la création de sujets (Boards) pour que ce soit uniquement possible par un **Moderator**
- Affichez le nom de l'usager qui a écrit un message dans chaque message à côté de la date (ce nom deviendra clickable)

:::warning
Seeding du user necessite EmailConfirmed : true
:::

## Ajoutez le soft delete
- 

## Ajoutez le hard delete
- 

## Ajoutez une vue qui permet de voir les utilisateurs

- Cette vue ne doit être accessible que par les modérateurs et les administateurs
- Ajoutez un lien dans la page de navigation
- Cette vue doit afficher chaque utilisateur avec l'information suivante:
    - Username
    - Email
    - S'il est admin
    - S'il est modérateur
    - S'il est banni
    - Les administrateurs doivent avoir la possibilité de changer les rôles (admin et modérateur)
    - Il faut également pouvoir bannir un utilisateur

## Ajoutez une vue qui affiche les détails d'un utilisateur
- Cette vue est accessible par tout le monde
- On l'affiche lorsque l'on clique sur le nom de l'utilisateur d'un message
- Cette vue est une fenêtre modal
- Cette vue est une vue partielle qui est obtenu grace à un appel ajax
- Cette vue permet de bannir un usager

## Les règles de sécurité:
### L'ensemble des actions qui peuvent être effectués par les utilisateurs selon leur rôle

- Sans être connecté, un usager peut voir les messages et voir les détails de l'**utilisateur** qui a publié un **Message**.
- Un usager connecté est considéré un **utilisateur**
- Un **utilisateur** peut envoyer des messages et effacer ses propres **Messages** (de façon permanente).
- Un **moderator** peut voir la liste des **utilisateurs**.
- Un **moderator** peut créer une nouveau **Board**.
- Un **moderator** peut **cacher** un **message** (soft delete) ou le réafficher.
    Lorsqu'un **message** est **caché**, il n'est plus visible sauf par des **utilisateurs** avec un rôle **Admin** ou **Moderator** qui peuvent également le réafficher. [Pas de confirmation]
- **Moderator** peut bannir un usager, sauf si l'utilisateur a un rôle **Admin** ou **Moderator**.
- **Admin** peut tout faire ce que **Moderator** peut faire, incluant **cacher** un **message**, mais aussi l'**effacer** de façon permanente comme si c'était l'**utilisateur** qui a écrit le **message**. Il peut **bannir** un utilisateur et ce peu importe le **Role** de l'**utilisateur**.
- **Admin** peut donner les droits **Moderator** et **Admin** ou les retirer.
- Protection contre les erreurs. Un **utilisateur** ne peut pas se bannir lui même et il ne peut pas se retirer les droits **admin**! (pour faire simple, on peut dire qu'un **utilisateur** ne peut pas modifier ses propres **roles**)
- Un **utilisateur** **banni** ne peut faire aucune action qu'un **utilisateur** peut faire normalement (Il n'y a que les fonctions qui sont accessibles sans connection qui restent accessible)
- Il n'est pas interdit qu'un utilisateur soit à la fois un **Moderator** et un **Admin**, mais si c'est le cas, il doit se comporter de la même façon qu'un **Admin**



Déjà fait à l'avance:
- Création d'un projet MVC
- Création de la classe Message
- Création de la classe Board
- Création d'une première migration qui va créer le DBContext
- Affichage de boards avec ordre par index
- Affichage de messages (username et date) [order by timestamp]
- Seeding de boards et messages

À faire:

- Ajouter un username à choisir au login (doit être unique)
- Afficher le username et non le email dans le menu de login

- Afficher le bouton delete quand l'utilisateur est un Moderator

